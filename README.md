#  ‚öôÔ∏è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ 

## üß∞ –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ rim-router-service-ver-cgo

–§–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–±–æ—Ä–∫—É, —Å–∂–∞—Ç–∏–µ, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫—É –ø—Ä–æ–µ–∫—Ç–∞.
–ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω–æ, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏ –∫–∞–∫ –∏—Ö —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.

---

### ‚öôÔ∏è –¢—Ä–µ–±—É–µ–º–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–î–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ª–∏—á–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

#### 1. **Go (Golang)**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞.

* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: **Go 1.21+**
* –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

  ```bash
  go version
  ```
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (Linux / macOS):

  ```bash
  sudo apt install golang-go -y       # Debian/Ubuntu
  # –∏–ª–∏
  brew install go                     # macOS
  ```
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è):

  ```bash
  wget https://go.dev/dl/go1.22.2.linux-amd64.tar.gz
  sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.22.2.linux-amd64.tar.gz
  export PATH=$PATH:/usr/local/go/bin
  ```

#### 2. **UPX (Ultimate Packer for eXecutables)**

–ù–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Å–∂–∞—Ç–∏—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–∞–Ω–¥–µ `make upx`).

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

  ```bash
  upx --version
  ```
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞:

  ```bash
  sudo apt install upx -y             # Debian/Ubuntu
  # –∏–ª–∏
  brew install upx                    # macOS
  ```

#### 3. **CGO –∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä C (–¥–ª—è Linux-—Å–±–æ—Ä–∫–∏)**

–ü—Ä–∏ –∫—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ü–∏–∏ (`make linux`) —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ **CGO**.

* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏:

  ```bash
  sudo apt install build-essential -y
  ```

---

### üß± –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Makefile

| –ö–æ–º–∞–Ω–¥–∞      | –û–ø–∏—Å–∞–Ω–∏–µ                                                                            |
| ------------ | ----------------------------------------------------------------------------------- |
| `make build` | –°–æ–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫ (–±–µ–∑ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä). |
| `make upx`   | –°–∂–∏–º–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫ —Å –ø–æ–º–æ—â—å—é UPX (`--best --lzma`).                                   |
| `make run`   | –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `go run`.                                           |
| `make test`  | –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞.                                                        |
| `make clean` | –£–¥–∞–ª—è–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `build/` –∏ `logs/`.                                              |
| `make linux` | –ö—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–¥ Linux `amd64` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CGO.                                |

---

### üß© –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–±–æ—Ä–∫–∏

```bash
# 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone https://github.com/lvzvrv/rim-router-service-ver-cgo.git
cd rim-router-service-ver-cgo

# 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
sudo apt install golang-go upx build-essential -y

# 3. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
make build

# 4. (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –°–∂–∏–º–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫
make upx

# 5. –ó–∞–ø—É—Å–∫–∞–µ–º
make run
```

---

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `make build` —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–∏–Ω–∞—Ä–Ω–∏–∫:

```
/build/router-service
```

–∏–ª–∏ (–ø—Ä–∏ `make linux`):

```
/build/router-service-linux
```

–ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é:

```bash
ls -lh build/
./build/router-service
```

---


# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
rim-router-service-ver-cgo
‚îú‚îÄ‚îÄ build/                           # –°–æ–±—Ä–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ data.db                      # –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
‚îÇ   ‚îú‚îÄ‚îÄ data.db-shm / data.db-wal    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã SQLite (–∂—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ router-service               # –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª Go-—Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ tir_logs/                    # –ü–∞–ø–∫–∞ —Å –ª–æ–≥–∞–º–∏
‚îÇ       ‚îî‚îÄ‚îÄ api.log                  # –õ–æ–≥ —Ä–∞–±–æ—Ç—ã API

‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îî‚îÄ‚îÄ main.go                  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤)

‚îú‚îÄ‚îÄ internal/                        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwt.go                   # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JWT-—Ç–æ–∫–µ–Ω–æ–≤
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sqlite_cgo.go            # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SQLite —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CGO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sqlite_stub.go           # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ CGO (–¥–ª—è —Å–±–æ—Ä–∫–∏ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seed_admin.go            # –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ handlers/                    # HTTP-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã REST API)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.go                  # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, refresh —Ç–æ–∫–µ–Ω–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logs.go                  # –†–∞–±–æ—Ç–∞ —Å –ª–æ–≥–∞–º–∏ (–ø—Ä–æ—Å–º–æ—Ç—Ä, –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.go                 # –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ä–æ–ª–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.go                   # –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /health, –≤–µ—Ä—Å–∏—è –ü–û)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ middleware/                  # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (middlewares)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.go                  # –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ models/                      # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞–±–æ—Ç–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.go                  # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –Ω–∏–º
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ token_repository.go      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –∏—Ö —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ utils/                       # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ jwt.go                   # –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å JWT
‚îÇ       ‚îú‚îÄ‚îÄ logging.go               # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ logfinder.go             # –ü–æ–∏—Å–∫ –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
‚îÇ       ‚îî‚îÄ‚îÄ logparser.go             # –ß—Ç–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ª–æ–≥–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ migrations/                      # SQL-–º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ 001_create_users.up.sql      # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ 001_create_users.down.sql    # –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (—É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ db_tool.go                   # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è/–º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å –ë–î –≤—Ä—É—á–Ω—É—é
‚îÇ
‚îú‚îÄ‚îÄ Makefile                         # –ö–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏, —Å–∂–∞—Ç–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ go.mod                           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∏–º—è –º–æ–¥—É–ª—è
‚îî‚îÄ‚îÄ go.sum                           # –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```
# ‚öôÔ∏è –§–∞–π–ª `main.go`

–§–∞–π–ª **`main.go`** —è–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞:

1. **–ó–∞–ø—É—Å–∫–∞–µ—Ç HTTP-—Å–µ—Ä–≤–µ—Ä** –Ω–∞ –±–∞–∑–µ `chi`-—Ä–æ—É—Ç–µ—Ä–∞  
2. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ `zerolog` –∏ `utils.NewRotatingWriter()`  
3. **–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** SQLite (—á–µ—Ä–µ–∑ `internal/db`)  
4. **–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü  
5. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** –∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã (`authHandler`, `adminHandler`)  
6. **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã –∏ middleware**

---

### üîπ –ó–∞–ø—É—Å–∫ –ª–æ–≥–≥–µ—Ä–∞

```go
logger := setupLogger()
defer logger.Info().Msg("Server shutdown")

if err := loadConfig(*configPath, logger); err != nil {
	logger.Fatal().Err(err).Msg("Failed to load config")
}
```
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è zerolog —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π –ª–æ–≥–æ–≤.
–í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤–∞—Ä–∏–π–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

### üîπ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```go
dbConn, err := database.OpenSQLite("./data.db")
if err != nil {
	logger.Fatal().Err(err).Msg("Failed to open database")
}
defer dbConn.Close()
```
–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (*sql.DB) –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.

### üîπ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
```go
if err := runMigrations(dbConn); err != nil {
	logger.Fatal().Err(err).Msg("Migrations failed")
}

database.SeedAdmin(userRepo)
```
runMigrations() —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã users –∏ refresh_tokens, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç.
SeedAdmin() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ —Å–æ–∑–¥–∞—ë—Ç –µ–≥–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

### üîπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
```go
userRepo := models.NewUserRepository(dbConn)
tokenRepo := models.NewTokenRepository(dbConn)
–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ‚Äî —Å–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:
```
userRepo —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (users),

tokenRepo —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü–µ–π refresh-—Ç–æ–∫–µ–Ω–æ–≤ (refresh_tokens).

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—Ç SQL-–ª–æ–≥–∏–∫—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —É–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏.

### üîπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
```go
authHandler := handlers.NewAuthHandler(userRepo, tokenRepo)
adminHandler := handlers.NewAdminHandler(userRepo)
```
authHandler ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã /api/v1/login, /register, /refresh, /logout

adminHandler ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã /admin/users –∏ /admin/users/{id}/role

–•–µ–Ω–¥–ª–µ—Ä—ã ‚Äî —ç—Ç–æ —Å–ª–æ–π API-–ª–æ–≥–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

### üîπ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞ –∏ middleware
```go
r := chi.NewRouter()

r.Use(chimiddleware.RequestID)                 // –¥–æ–±–∞–≤–ª—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É
r.Use(chimiddleware.RealIP)                    // –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π IP –∫–ª–∏–µ–Ω—Ç–∞
r.Use(chimiddleware.Recoverer)                 // –ª–æ–≤–∏—Ç –ø–∞–Ω–∏–∫–∏, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–∞–¥–∞–ª
r.Use(chimiddleware.Timeout(60 * time.Second)) // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
r.Use(zerologMiddleware(logger))               // –ª–æ–≥–∏—Ä—É–µ—Ç –º–µ—Ç–æ–¥, –ø—É—Ç—å, —Å—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º—è
```
Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–æ –∫–∞–∂–¥–æ–≥–æ —Ö–µ–Ω–¥–ª–µ—Ä–∞ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å:

RequestID ‚Äî –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID

RealIP ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π IP –∫–ª–∏–µ–Ω—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Å—Ç–æ–∏—Ç –∑–∞ –ø—Ä–æ–∫—Å–∏

Recoverer ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–Ω–∏–∫–∏ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

Timeout ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã

zerologMiddleware ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ª–æ–≥ –º–µ—Ç–æ–¥, –ø—É—Ç—å, —Å—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

### üîπ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
```go
// --- Public endpoints ---
r.Get("/health", handlers.HealthHandler)
r.Post("/api/v1/register", authHandler.Register)
r.Post("/api/v1/login", authHandler.Login)
r.Post("/api/v1/refresh", authHandler.Refresh)
r.Post("/api/v1/logout", authHandler.Logout)

// --- Authenticated v1 ---
r.Route("/api/v1", func(r chi.Router) {
	r.Use(myMiddleware.AuthMiddleware)
	r.Get("/softwareVer", handlers.GetSoftwareVer)
})

// --- Admin-only v2 (logs, user management, etc.) ---
r.Route("/api/v2", func(r chi.Router) {
	r.Use(myMiddleware.AuthMiddleware)
	r.With(myMiddleware.RoleMiddleware(1)).Group(func(r chi.Router) {
		// --- System logs ---
		r.Get("/logs", handlers.ListAllLogs)
		r.Get("/logs/download-all", handlers.DownloadAllLogs)
		r.Get("/logs/download", handlers.DownloadSelectedLogs)
		r.Get("/logs/tail", handlers.TailUnified)

		// --- User management ---
		r.Get("/admin/users", adminHandler.ListUsers)
		r.Post("/admin/users/{id}/role", adminHandler.UpdateUserRole)
	})
})
```
–†–æ—É—Ç–µ—Ä –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω –ø–æ —É—Ä–æ–≤–Ω—è–º –¥–æ—Å—Ç—É–ø–∞:

–ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã ‚Äî /health, /login, /register

–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã ‚Äî /api/v1/... (—Ç—Ä–µ–±—É—é—Ç JWT)

–ê–¥–º–∏–Ω—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã ‚Äî /api/v2/... (—Ç—Ä–µ–±—É—é—Ç —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

### üîπ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
–§—É–Ω–∫—Ü–∏—è setupLogger() –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç zerolog —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ utils.NewRotatingWriter().
–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

```
–º–µ—Ç–æ–¥ | –ø—É—Ç—å | —Å—Ç–∞—Ç—É—Å | —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ | –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```
–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ build/tir_logs/ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞.

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è runMigrations()
–°–æ–∑–¥–∞—ë—Ç –±–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:

users ‚Äî —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—Ö —Ä–æ–ª–∏ –∏ –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è

# üîê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è JWT (`internal/config/jwt.go`)

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT-—Ç–æ–∫–µ–Ω–æ–≤.

```go
type JWTConfig struct {
    Secret            string
    AccessExpiration  time.Duration
    RefreshExpiration time.Duration
}
```

refresh_tokens ‚Äî —Ö—Ä–∞–Ω–∏—Ç refresh-—Ç–æ–∫–µ–Ω—ã, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏ —Å–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

–¢–∞–∫–∂–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ –ø–æ username –∏ token.

# üóÑÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (`internal/db/sqlite_cgo.go`)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç CGO-–¥—Ä–∞–π–≤–µ—Ä `github.com/mattn/go-sqlite3` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite.
| –≠–ª–µ–º–µ–Ω—Ç                           | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                            |
| --------------------------------- | --------------------------------------------------------------------- |
| `//go:build cgo`                  | –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º CGO (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç C-–¥—Ä–∞–π–≤–µ—Ä SQLite) |
| `OpenSQLite(path)`                | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å SQLite, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—É–ª –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã            |
| `buildDSN()`                      | –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ                        |
| `buildDSNParams()`                | –î–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (timeout, WAL, foreign keys)                      |
| `SetMaxOpenConns(1)`              | –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤              |

#  üìò handlers/admin.go ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
–°—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:
```go
type AdminHandler struct {
	UserRepo *models.UserRepository
	logger   zerolog.Logger
}
```

###  üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func NewAdminHandler(userRepo *models.UserRepository) *AdminHandler```

–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞. –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–º–µ–ø–ª—è—Ä AdminHandler, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.


###  üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func (h *AdminHandler) ListUsers(w http.ResponseWriter, r *http.Request)```

–ó–∞–ø—Ä–æ—Å ``` GET http://localhost:8080/api/v2/admin/users ```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã:
1) –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞.
2) –û–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ UserRepo.GetAllUsers().
3) –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "Database error".
4) –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –∏ –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ JSON-–≤–∏–¥–µ:
```json
{
  "code": 200,
  "message": "OK",
  "data": [
    {"id":1,"username":"admin","role":1,"created_at":"..."},
    {"id":2,"username":"user1","role":0,"created_at":"..."}
  ]
}
```


###  üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func (h *AdminHandler) UpdateUserRole(w http.ResponseWriter, r *http.Request)```

–ó–∞–ø—Ä–æ—Å ``` POST http://localhost:8080/api/v2/admin/users/3/role```
–ò–∑–º–µ–Ω—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ id.
–û–∂–∏–¥–∞–µ–º–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```json
{ "role": 1 }
```
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ò–∑–≤–ª–µ–∫–∞–µ—Ç id –∏–∑ URL ```go (chi.URLParam(r, "id"))```, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —ç—Ç–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.
–û—à–∏–±–∫–∞ ‚Üí ```400 Invalid user ID```.

2) –ü–∞—Ä—Å–∏—Ç JSON-—Ç–µ–ª–æ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É ```{ Role int }```.
–û—à–∏–±–∫–∞ ‚Üí ```400 Invalid JSON```.

3) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è Role (0‚Äì2).
–û—à–∏–±–∫–∞ ‚Üí ```400 Invalid role value```.

4) –í—ã–∑—ã–≤–∞–µ—Ç ```go UserRepo.UpdateUserRole(id, role)```.
–û—à–∏–±–∫–∞ –ë–î ‚Üí ```500 Failed to update role```.

5) –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø–∏—à–µ—Ç –≤ –ª–æ–≥:
```json
{"level":"info","module":"admin","user_id":5,"new_role":1,"msg":"User role updated successfully"}
```

6) –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "Role updated successfully".


#  üìò handlers/auth.go ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
–†–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
–•—Ä–∞–Ω–∏—Ç refresh_token –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤ HttpOnly cookie –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access-—Ç–æ–∫–µ–Ω–∞.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:
```go
type AuthHandler struct {
	UserRepo  *models.UserRepository
	TokenRepo *models.TokenRepository
}

func NewAuthHandler(userRepo *models.UserRepository, tokenRepo *models.TokenRepository) *AuthHandler {
	return &AuthHandler{UserRepo: userRepo, TokenRepo: tokenRepo}
}
```
### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func (h *AuthHandler) Register(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ``` POST http://localhost:8080/api/v1/register```
–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–û–∂–∏–¥–∞–µ–º–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```json
{
  "username": "admin",
  "password": "admin123"
}
```
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –°—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è json
2) –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ª–æ–≥–∏–Ω (–æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤) –∏ –ø–∞—Ä–æ–ª—å (–û—Ç 6 —Å–∏–º–≤–æ–ª–æ–≤ + –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã: –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _)
3) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π username, —Ç–æ –≤—ã–≤–µ–¥–µ—Ç ```"User already exists"```
4) –ü–∞—Ä–æ–ª—å —Ö—ç—à–∏—Ä—É–µ—Ç—Å—è (–≤ –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö—ç—à –ø–∞—Ä–æ–ª—è)
5) –ï—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, —Ç–æ –≤—ã–≤–µ–¥–µ—Ç ```"User registered successfully"```

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func (h *AuthHandler) Login(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ``` POST http://localhost:8080/api/v1/login```
–ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–¥–∞–µ—Ç –ø–∞—Ä—É —Ç–æ–∫–µ–Ω–æ–≤ (access, refresh)
–û–∂–∏–¥–∞–µ–º–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```json
{
  "username": "admin",
  "password": "admin123"
}
```
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –ø–æ username
2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—ç—à–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
3) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Access token
4) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Refresh token
5) –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ```200 OK``` –∏ JSON
```json
{
  "code": 200,
  "message": "Login successful",
  "data": {
    "access_token": "<jwt>",
    "role": 0
  }
}
```
### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func (h *AuthHandler) Refresh(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ``` POST http://localhost:8080/api/v1/refresh```
–û–±–Ω–æ–≤–ª—è–µ—Ç Access JWT-token
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ò—â–µ—Ç refresh token –≤ cookie
2) –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫–∏ –∏ –≤ –ë–î + –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫
3) –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π refresh token –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π
4) –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –≤ –ë–î –∏ –∫—É–∫–∏
5) –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π access token
6) –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ```200 OK``` –∏ JSON:
```json
{
  "code": 200,
  "message": "Token refreshed",
  "data": {
    "access_token": "<new_jwt>"
  }
}
```
### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func (h *AuthHandler) Logout(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ``` POST http://localhost:8080/api/v1/logout```
–í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ò–∑–≤–ª–µ–∫–∞–µ—Ç refresh token –∏–∑ cookie
2) –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω, —Ç–æ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ –∏–∑ –ë–î –∏ –æ—á–∏—â–∞–µ—Ç cookie
3) –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ```200 OK``` –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ ```"Logged out"```.

#  üìò handlers/logs.go ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–í —Ñ–∞–π–ª–µ —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ª–æ–≥–æ–≤
### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func ListAllLogs(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ```GET http://localhost:8080/api/v2/logs```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ª–æ–≥ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –í—ã–∑—ã–≤–∞–µ—Ç ```utils.DiscoverLogFiles(false)``` –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º ```.log```.
2) –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (```Modified``` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–≤–µ—Ä—Ö—É).
3) –§–æ—Ä–º–∏—Ä—É–µ—Ç JSON-–æ—Ç–≤–µ—Ç —Å–æ —Å–≤–µ–¥–µ–Ω–∏—è–º–∏ –æ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ:
```name``` ‚Äî –∏–º—è —Ñ–∞–π–ª–∞
```dir``` ‚Äî –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```path``` ‚Äî –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
```root``` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "local")
```size``` ‚Äî —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
```human``` ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä (KB/MB)
```modified``` ‚Äî –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
4) –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ```200 OK``` —Å –º–∞—Å—Å–∏–≤–æ–º —Ñ–∞–π–ª–æ–≤.
–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
```json
{
  "code": 200,
  "message": "OK",
  "data": [
    {
      "name": "api.log",
      "dir": "/logs",
      "path": "/logs/api.log",
      "root": "local",
      "size": 15234,
      "human": "15 KB",
      "modified": "2025-10-23 14:01:32"
    }
  ]
}
```

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func DownloadAllLogs(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ```GET http://localhost:8080/api/v2/logs/download-all``` 

–°–æ–∑–¥–∞–µ—Ç ZIP-–∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –ª–æ–≥–∞–º–∏
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ ```utils.DiscoverLogFiles(true)```.
–ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ```404 no logs found```.

2) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏:
```
Content-Type: application/zip  
Content-Disposition: attachment; filename="logs_all_<timestamp>.zip"
```

3) –ê—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã ‚Äú–Ω–∞ –ª–µ—Ç—É‚Äù —á–µ—Ä–µ–∑ ```zip.Writer``` –∏ ```io.Pipe()```.

4) –ö–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É –≤–Ω—É—Ç—Ä–∏ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∞–ø–∫—É –ø–æ –∏–º–µ–Ω–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (```root```).

–†–µ–∑—É–ª—å—Ç–∞—Ç:

–°–∫–∞—á–∏–≤–∞–µ–º—ã–π –∞—Ä—Ö–∏–≤:
```
logs_all_20251023T150405.zip
 ‚îú‚îÄ‚îÄ local/
 ‚îÇ   ‚îú‚îÄ‚îÄ api.log
 ‚îÇ   ‚îú‚îÄ‚îÄ Modbus_BEMP.log
```
–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –∏—Å–∫–ª—é—á–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–ª–ª–∏–∑–∏–∏ –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –¥–∏—Ä—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func TailUnified(w http.ResponseWriter, r *http.Request)```
–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ ```GET http://localhost:8080/api/v2/logs/tail?name=IRZ_ModbusOvenOk.20250919T073501.log&root=local&lines=200&format=raw```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ ```N``` —Å—Ç—Ä–æ–∫ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ                                             |
| -------- | ------------ | -----------------------------------------------------|
| `name`   | ‚úÖ           |  –ò–º—è –ª–æ–≥-—Ñ–∞–π–ª–∞ (`api.log`)                           |
| `lines`  | ‚ùå           |  –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ —Å –∫–æ–Ω—Ü–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 200)         |
| `format` | ‚ùå           |  `json` –∏–ª–∏ `raw`                                    |
| `root`   | ‚úÖ           |  –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ª–æ–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"local"`) |

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ```name``` –∏ ```root```.

2) –ù–∞—Ö–æ–¥–∏—Ç —Ñ–∞–π–ª —á–µ—Ä–µ–∑ ```utils.ResolveOneByName```.

3) –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ (```utils.OpenSafe```).

4) –ß–∏—Ç–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ ```N``` —Å—Ç—Ä–æ–∫ (```utils.ReadTailLines```).

5) –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç:

```format=raw``` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç (text/plain);

```format=json``` ‚Üí –ø–∞—Ä—Å–∏—Ç JSON-–∑–∞–ø–∏—Å–∏ –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏ –≤ —Å–∫–æ–±–∫–∞—Ö (```utils.ParseBracketLine```).

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (```format=json```):
```json
{
  "code": 200,
  "message": "OK",
  "data": [
    {"level":"info","msg":"Admin requested user list","time":"2025-10-23T14:00:00Z"},
    {"level":"error","msg":"Database error","time":"2025-10-23T14:01:00Z"}
  ]
}
```

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func DownloadSelectedLogs(w http.ResponseWriter, r *http.Request)```
–ó–∞–ø—Ä–æ—Å ```GET POST http://localhost:8080/api/v2/logs/download```

–ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤ –≤–∏–¥–µ ZIP-–∞—Ä—Ö–∏–≤–∞.
–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```json
{
  "files": [
    {"name": "api.log", "root": "local"},
    {"name": "Modbus_BEMP.log", "root": "local"}
  ]
}
```
–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JSON, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç ```name``` –∏ ```root```.

2) –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø—É—Ç–∏ —á–µ—Ä–µ–∑ ```utils.ResolveOneByName```.

3) –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí ```404 not found: <file> (<root>)```.

4) –§–æ—Ä–º–∏—Ä—É–µ—Ç ZIP-–∞—Ä—Ö–∏–≤ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏.

5) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏:
```
Content-Type: application/zip
Content-Disposition: attachment; filename="logs_selected_<timestamp>.zip"
```
6) –ê—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã ‚Äú–Ω–∞ –ª–µ—Ç—É‚Äù —á–µ—Ä–µ–∑ ```addFileToZipWithRoot```.

###  üß∞ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
```addFileToZipWithRoot(zw *zip.Writer, fullPath, root string) error```

–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –≤ ZIP –≤ –ø–æ–¥–ø–∞–ø–∫—É —Å –∏–º–µ–Ω–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (```root```).
–ü—Ä–∏–º–µ—Ä: ```local/api.log```.
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ```0o644``` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞—Ç—É –∏–∑–º–µ–Ω–µ–Ω–∏—è.

```parseIntDefault(s string, d int) int```

–ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ; –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (```d```).


#  üîí internal/middleware/auth.go ‚Äî middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
–ú–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (middleware) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT-—Ç–æ–∫–µ–Ω–∞ –∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö /api/v1 –∏ /api/v2 –¥–ª—è –∑–∞—â–∏—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

###  ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
| Middleware           | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                    |
| -------------------- | ----------------------------------------------------------------------------- |
| `AuthMiddleware`     | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å JWT-—Ç–æ–∫–µ–Ω–∞ (`Authorization: Bearer <token>`) |
| `RoleMiddleware`     | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å—É          |
| `GetUserFromContext` | –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (claims) –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞             |

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func AuthMiddleware(next http.Handler) http.Handler```
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JWT access-—Ç–æ–∫–µ–Ω–∞ –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ò—â–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ ```Authorization```.
–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ```401 Authorization header required```.

2) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç:
```
Authorization: Bearer <token>
```

–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí ```401 Invalid authorization format```.

3) –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω:
```go
claims, err := utils.ValidateToken(tokenString)
```

–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ ‚Üí ```401 Invalid token```.

4) –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ```claims``` (–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç:
```go
ctx := context.WithValue(r.Context(), UserContextKey, claims)
```

5) –ü–µ—Ä–µ–¥–∞—ë—Ç –∑–∞–ø—Ä–æ—Å –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.

–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:
```
{"code": 401, "message": "Invalid token"}
```

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```go
r.Route("/api/v1", func(r chi.Router) {
    r.Use(middleware.AuthMiddleware)
    r.Get("/profile", handlers.GetProfile)
})
```

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func RoleMiddleware(requiredRole int) func(http.Handler) http.Handler```
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç ```AuthMiddleware```.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤).

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1) –ò–∑–≤–ª–µ–∫–∞–µ—Ç ```claims``` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
```go
claims, ok := r.Context().Value(UserContextKey).(*utils.Claims)
```

–ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Üí ```401 Authentication required```.

2) –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç—Ä–µ–±—É–µ–º–æ–π:
```go
if claims.Role < requiredRole
```

–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ ‚Üí ```403 Insufficient permissions```.

3) –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø–µ—Ä–µ–¥–∞—ë—Ç –∑–∞–ø—Ä–æ—Å –¥–∞–ª—å—à–µ.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```go
r.Route("/api/v2", func(r chi.Router) {
    r.Use(middleware.AuthMiddleware)
    r.With(middleware.RoleMiddleware(1)).Group(func(r chi.Router) {
        r.Get("/admin/users", handlers.ListUsers)
    })
})
```

üß≠ –ó–¥–µ—Å—å 1 ‚Äî —ç—Ç–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (role=1).

–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–æ–∫:
```json
{"code": 401, "message": "Authentication required"}
```

### üóÇÔ∏è –§—É–Ω–∫—Ü–∏—è ```func GetUserFromContext(ctx context.Context) *utils.Claims```

–£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

–ü—Ä–∏–º–µ—Ä:
```go
func ProfileHandler(w http.ResponseWriter, r *http.Request) {
    user := middleware.GetUserFromContext(r.Context())
    if user == nil {
        http.Error(w, "Unauthorized", http.StatusUnauthorized)
        return
    }
    fmt.Fprintf(w, "Hello, %s!", user.Username)
}
```

üß† –ß—Ç–æ —Ç–∞–∫–æ–µ utils.Claims

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Claims –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ JWT-—Ç–æ–∫–µ–Ω–∞ (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ utils.jwt.go):
```go
type Claims struct {
	UserID   int64  `json:"user_id"`
	Username string `json:"username"`
	Role     int    `json:"role"`
	Exp      int64  `json:"exp"`
	Iat      int64  `json:"iat"`
}
```

# üìÅ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ë–î internal/models
## üß© internal/models/token_repository.go ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å refresh-—Ç–æ–∫–µ–Ω–∞–º–∏
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (handlers/auth.go) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
### ‚öôÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```go
type TokenRepository struct {
	DB *sql.DB
}
```

–•—Ä–∞–Ω–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (```*sql.DB```).
–ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã refresh_tokens.

–°–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:
```go
func NewTokenRepository(db *sql.DB) *TokenRepository
```
### üóÑÔ∏è –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã ```refresh_tokens```
```sql
CREATE TABLE refresh_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    token TEXT NOT NULL UNIQUE,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```
### üß† –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ
| –≠—Ç–∞–ø          | –ú–µ—Ç–æ–¥                                                         | –î–µ–π—Å—Ç–≤–∏–µ                                         |
| ------------- | ------------------------------------------------------------- | ------------------------------------------------ |
| üîë –õ–æ–≥–∏–Ω      | `SaveRefreshToken`                                            | –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π refresh-—Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ      |
| üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ | `GetRefreshToken` ‚Üí `DeleteRefreshToken` ‚Üí `SaveRefreshToken` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –∑–∞–º–µ–Ω—è–µ—Ç –µ–≥–æ –Ω–æ–≤—ã–º             |
| üö™ –í—ã—Ö–æ–¥      | `DeleteAllForUser`                                            | –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ refresh-—Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

## üë§ internal/models/user.go ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–†–µ–∞–ª–∏–∑—É–µ—Ç –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞–±–æ—Ä –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π users –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (```handlers/auth.go```) –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö (```handlers/admin.go```).

### ‚öôÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```go
type User struct {
	ID           int64     `json:"id"`
	Username     string    `json:"username"`
	PasswordHash string    `json:"-"`       // –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ JSON
	Role         int       `json:"role"`    // 0=user, 1=admin
	CreatedAt    time.Time `json:"created_at"`
}
```

### üß± –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    role INTEGER NOT NULL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```
### üîê –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
| –ó–Ω–∞—á–µ–Ω–∏–µ            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                      |
| ------------------- | ----------------------------------------------- |
| `0`                 | –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å                            |
| `1`                 | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä                                   |
| *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* `2` | –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å) |

### üß† –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ
| –ú–µ—Ç–æ–¥               | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                         | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è              |
| ------------------- | ---------------------------------- | ----------------------------- |
| `CreateUser`        | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è              | `Register`                    |
| `GetUserByUsername` | –ù–∞–π—Ç–∏ –ø–æ –∏–º–µ–Ω–∏                     | `Login`                       |
| `GetUserByID`       | –ù–∞–π—Ç–∏ –ø–æ ID                        | `Refresh`                     |
| `UserExists`        | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç                 | `Register`                    |
| `AdminExists`       | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–¥–º–∏–Ω–∞           | –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã         |
| `GetAllUsers`       | –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | `AdminHandler.ListUsers`      |
| `UpdateUserRole`    | –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å                      | `AdminHandler.UpdateUserRole` |


# üìÅ internal/utils ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
–ü–∞–ø–∫–∞ utils —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –æ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT-—Ç–æ–∫–µ–Ω–æ–≤.
–≠—Ç–∏ —É—Ç–∏–ª–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç—è—Ö —Å–∏—Å—Ç–µ–º—ã (handlers, middleware, models) –∏ —Å–ª—É–∂–∞—Ç ‚Äú—Å–ª—É–∂–µ–±–Ω—ã–º —Å–ª–æ–µ–º‚Äù –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –ª–æ–≥–∏–∫–∏.

## üì¶ –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
| –§–∞–π–ª               | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                                                                                              |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`jwt.go`**       | –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT, —Å–æ–∑–¥–∞–Ω–∏–µ secure refresh-—Ç–æ–∫–µ–Ω–æ–≤).                                                             |
| **`logfinder.go`** | –ü–æ–∏—Å–∫ –∏ —Å–±–æ—Ä –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ, –≤–∫–ª—é—á–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—Ä–µ, –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ ‚Äú–∫–æ—Ä–Ω–µ–≤–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ‚Äù (`root`).                             |
| **`logging.go`**   | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º –ª–æ–≥–æ–≤, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–µ—Ä–æ–≤ (`zerolog`), —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤.  |
| **`logparser.go`** | –†–∞–∑–±–æ—Ä –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤: –ø–∞—Ä—Å–∏–Ω–≥ JSON-–∑–∞–ø–∏—Å–µ–π, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –∏ —É—Ä–æ–≤–Ω–µ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. |

## üîê internal/utils/jwt.go ‚Äî —Ä–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ (JWT –∏ refresh)
–§–∞–π–ª –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é JWT access-—Ç–æ–∫–µ–Ω–æ–≤, –∞ —Ç–∞–∫–∂–µ –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö refresh-—Ç–æ–∫–µ–Ω–æ–≤.

### –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
```go
type Claims struct {
	UserID   int64  `json:"user_id"`
	Username string `json:"username"`
	Role     int    `json:"role"`
	jwt.StandardClaims
}
```

### üßæ `func GenerateAccessToken(user *models.User) (string, error)`
–°–æ–∑–¥–∞—ë—Ç **JWT access-—Ç–æ–∫–µ–Ω** –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
#### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `config.GetJWTConfig()` (—Å–µ–∫—Ä–µ—Ç, –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∏ —Ç.–¥.).
2. –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç `Claims` —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è:
   - `ExpiresAt` ‚Äî —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –º–∏–Ω—É—Ç),
   - `IssuedAt` ‚Äî –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è.
4. –°–æ–∑–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω —Å –ø–æ–¥–ø–∏—Å—å—é HMAC-SHA256:
   ```go
   token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)

5. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º:
	```go
   token.SignedString([]byte(jwtConfig.Secret))
	```
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π JWT-—Ç–æ–∫–µ–Ω (—Å—Ç—Ä–æ–∫–æ–π).
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:
`AuthHandler.Login()` ‚Äî –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ;
`AuthHandler.Refresh()` ‚Äî –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤.
–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ JWT (–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payload):
	```go
	{
  	"user_id": 1,
  	"username": "admin",
  	"role": 1,
  	"exp": 1730000000,
  	"iat": 1729996400
	}
	```
## ‚úÖ func ValidateToken(tokenString string) (*Claims, error)
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç JWT-—Ç–æ–∫–µ–Ω –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è.
#### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç Secret –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞.
2. –†–∞–∑–±–∏—Ä–∞–µ—Ç —Ç–æ–∫–µ–Ω:
	```go
	jwt.ParseWithClaims(tokenString, claims, func(token *jwt.Token) (interface{}, error) {
	    return []byte(jwtConfig.Secret), nil
	})
	```
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
–ø–æ–¥–ø–∏—Å—å (`signature`),
—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (`exp`),
—Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞.
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
`*Claims` ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞;
`error` ‚Äî –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (–Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å, –∏—Å—Ç—ë–∫, –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏ —Ç.–¥.).
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:
`middleware.AuthMiddleware()` ‚Äî –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞—â–∏—â—ë–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.

## üîí func GenerateSecureToken() (string, error)
–°–æ–∑–¥–∞—ë—Ç refresh-—Ç–æ–∫–µ–Ω ‚Äî —Å–ª—É—á–∞–π–Ω—É—é –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫—É—é —Å—Ç—Ä–æ–∫—É –¥–ª–∏–Ω–æ–π 64 —Å–∏–º–≤–æ–ª–∞ (256 –±–∏—Ç —ç–Ω—Ç—Ä–æ–ø–∏–∏).
–≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JWT –∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

#### –õ–æ–≥–∏–∫–∞:

1. –°–æ–∑–¥–∞—ë—Ç –±—É—Ñ–µ—Ä 32 –±–∞–π—Ç–∞:
```go
buf := make([]byte, 32)
```
2. –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–º–∏ –±–∞–π—Ç–∞–º–∏ (crypto/rand).
3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ hex-—Å—Ç—Ä–æ–∫—É (—É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ cookie).
–ü—Ä–∏–º–µ—Ä:
`d4a3b9a50d4a5ef3d35f4f28e1a142df76cf8d6a79b87b0c8ce7c1c7f0cbba8b`
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:
`AuthHandler.Login()` ‚Äî –ø—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
`AuthHandler.Refresh()` ‚Äî –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä—ã —Ç–æ–∫–µ–Ω–æ–≤.

## üß≠ internal/utils/logfinder.go ‚Äî –ø–æ–∏—Å–∫ –∏ –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥-—Ñ–∞–π–ª–∞–º
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ –≤ –∑–∞—Ä–∞–Ω–µ–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∫–æ—Ä–Ω—è—Ö (local, sd). –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ñ–∞–π–ª–∞–º–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .log.

–ò—â–µ—Ç —Ç–æ–ª—å–∫–æ .log (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ).
```go
var extLogRe = regexp.MustCompile(`(?i)\.log$`)
```
üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
```go
type LogInfo struct {
	Path     string    `json:"path"`
	Name     string    `json:"name"`
	Dir      string    `json:"dir"`
	Size     int64     `json:"size"`
	Modified time.Time `json:"modified"`
	RootID   string    `json:"root_id"` // "local" / "sd"
}

type Root struct {
	ID   string // "local", "sd"
	Path string // –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ tir_logs
}
```
### üå± func ListRoots() []Root
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–Ω–µ–π, –≥–¥–µ –º–æ–≥—É—Ç –ª–µ–∂–∞—Ç—å –ª–æ–≥–∏.

#### –õ–æ–≥–∏–∫–∞:
1. –î–æ–±–∞–≤–ª—è–µ—Ç `local: ./tir_logs` —Ä—è–¥–æ–º —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º (—Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ `0o755`).
2. –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏—Ç `/mnt` –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤—Å–µ –∫–∞—Ç–∞–ª–æ–≥–∏, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞ `tir_logs` –∫–∞–∫ `sd`.
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ `Path`).

### üìÉ func AllowedRoots() []string
–°–æ–≤–º–µ—Å—Ç–∏–º–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ ListRoots() ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—É—Ç–∏ –∫–æ—Ä–Ω–µ–π. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è checks –≤ OpenSafe.

### üß™ func LooksLikeLog(name string) bool
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∏–º—è –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ª–æ–≥-—Ñ–∞–π–ª (*.log), –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞.

### üõ°Ô∏è func WithinAllowedRoots(p string, roots []string) bool
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å p –ª–µ–∂–∏—Ç –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π.

### üß∞ func strconvI(i int) string
–ú–∏–Ω–∏-—É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ int –≤ —Å—Ç—Ä–æ–∫—É –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è strconv.

### üìö func DiscoverLogFiles(includeTimestamped bool) ([]LogInfo, error)
–ò—â–µ—Ç –≤—Å–µ .log –≤–æ –≤—Å–µ—Ö –∫–æ—Ä–Ω—è—Ö –∏–∑ ListRoots(), —Å–æ–±–∏—Ä–∞—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.
#### –õ–æ–≥–∏–∫–∞:
1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ `root.Path` –≤—ã–ø–æ–ª–Ω—è–µ—Ç `filepath.WalkDir`.
–ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏; –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã, –ø—Ä–æ—à–µ–¥—à–∏–µ `LooksLikeLog`.
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç `LogInfo (Abs, Dir, Size, ModTime, RootID)`.
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤.

### üîç func FindLogsByName(name string) ([]LogInfo, error)
–ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å—Ä–µ–¥–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∫–æ—Ä–Ω–µ–π.
#### –õ–æ–≥–∏–∫–∞:
1. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç `name` (–Ω–µ –ø—É—Å—Ç–æ–π –∏ *.log).
2. –ë–µ—Ä—ë—Ç –≤—Å–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ `DiscoverLogFiles(true)`.
3. –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –∏–º–µ–Ω–∏ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ (`EqualFold`).
4. –°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ:
–°–Ω–∞—á–∞–ª–∞ `local`, –∑–∞—Ç–µ–º `sd`;
–í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ RootID ‚Äî –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ).

### üéØ func ResolveOneByName(name, rootHint string) (LogInfo, error)
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –ø–æ –∏–º–µ–Ω–∏ –∏ —è–≤–Ω–æ–º—É —É–∫–∞–∑–∞–Ω–∏—é –∫–æ—Ä–Ω—è.
#### –õ–æ–≥–∏–∫–∞:
1. –í—ã–∑—ã–≤–∞–µ—Ç `FindLogsByName(name)`.
2. –¢—Ä–µ–±—É–µ—Ç –Ω–µ–ø—É—Å—Ç–æ–π `rootHint` (–∏–Ω–∞—á–µ –æ—à–∏–±–∫–∞).
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—ã–π `LogInfo` —Å —Å–æ–≤–ø–∞–¥–∞—é—â–∏–º `RootID`.
4. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –æ—à–∏–±–∫–∞ (`"log not found", "no match for given root"`).

### üîì func OpenSafe(path string) (*os.File, error)
–ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –ª–µ–∂–∏—Ç –≤ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∫–æ—Ä–Ω—è—Ö.
#### –õ–æ–≥–∏–∫–∞:
1. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–Ω–µ–π: `AllowedRoots()`.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `WithinAllowedRoots(path, roots)`.
3. –ï—Å–ª–∏ –æ–∫ ‚Äî `os.Open(path)`, –∏–Ω–∞—á–µ –æ—à–∏–±–∫–∞ `"path not allowed"`.

üß™ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ LogInfo (JSON)
```json
{
  "path": "/opt/app/tir_logs/api.log",
  "name": "api.log",
  "dir": "/opt/app/tir_logs",
  "size": 15234,
  "modified": "2025-10-23T14:01:32Z",
  "root_id": "local"
}
```

## ‚öôÔ∏è internal/utils/log_utils.go ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤

–§–∞–π–ª –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–æ—Ç–∞—Ü–∏—é –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤.

---

### üìÅ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```go
const (
	PreferredSDPath  = "/mnt"       // –ø—É—Ç—å, –≥–¥–µ –∏—â–µ—Ç—Å—è –ø–∞–ø–∫–∞ tir_logs –Ω–∞ SD-–∫–∞—Ä—Ç–µ
	LocalLogPath     = "./tir_logs" // fallback ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
	LogFileName      = "api.log"    // –∏–º—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞
	MaxLogSizeBytes  = 5 * 1024 * 1024 // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (5 MB)
	MaxArchivedFiles = 5               // —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ 5 –∞—Ä—Ö–∏–≤–æ–≤
	MinFreeSpaceMB   = 6               // –º–∏–Ω–∏–º—É–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ MB
)
```

---

### üìÇ `func ChooseLogDir() string`

–í—ã–±–∏—Ä–∞–µ—Ç –º–µ—Å—Ç–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤:

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ `tir_logs` –Ω–∞ SD-–∫–∞—Ä—Ç–µ (`/mnt`).
2. –ï—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë.
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω—É—é `./tir_logs` —Ä—è–¥–æ–º —Å –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–º.

üìÑ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `ensureDir()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏.

---

### üß© `func ensureDir(dir string) error`

–°–æ–∑–¥–∞—ë—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–µ—Å–ª–∏ –Ω–µ—Ç) –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏, —Å–æ–∑–¥–∞–≤–∞—è –∏ —É–¥–∞–ª—è—è —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `.test`.

---

### üìå `func LogDir() string`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤. –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç `ChooseLogDir()`.

---

### üìÑ `func LogFilePath() string`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É `api.log` –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤.

---

### ü™£ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `RotatingWriter`

–†–µ–∞–ª–∏–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ.

```go
type RotatingWriter struct {
	file *os.File
}
```

#### üßæ `func NewRotatingWriter() (*RotatingWriter, error)`

–°–æ–∑–¥–∞—ë—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª `api.log` –¥–ª—è –∑–∞–ø–∏—Å–∏. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π.

#### ‚úçÔ∏è `func (w *RotatingWriter) Write(p []byte)`

–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞. –ê–ª–≥–æ—Ä–∏—Ç–º:

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ (`checkDiskSpaceAndCleanup()`).
3. –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç `MaxLogSizeBytes` ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç `rotate()`.
4. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª.

#### üîÅ `func (w *RotatingWriter) rotate() error`

–†–µ–∞–ª–∏–∑—É–µ—Ç —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤:

1. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª.
2. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç `api.log` –≤ `api.YYYYMMDDTHHMMSS.log`.
3. –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π `api.log`.
4. –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `cleanupOldLogs()` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤.

#### üßπ `func (w *RotatingWriter) Close() error`

–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã.

---

### üóëÔ∏è `func cleanupOldLogs()`

–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã –ª–æ–≥–æ–≤ –ø–æ —à–∞–±–ª–æ–Ω—É `api.YYYYMMDDTHHMMSS.log`, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ `MaxArchivedFiles`.

1. –°–∫–∞–Ω–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤.
2. –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∞—Ä—Ö–∏–≤—ã –ø–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
3. –£–¥–∞–ª—è–µ—Ç —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ.

---

### üíæ `func checkDiskSpaceAndCleanup() error`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ —Å –ø–æ–º–æ—â—å—é `syscall.Statfs`.

1. –ï—Å–ª–∏ –º–µ–Ω—å—à–µ `MinFreeSpaceMB` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –≤ –ª–æ–≥–µ –∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã.
2. –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏.
3. –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É.

---

### ‚è±Ô∏è `func FormatTS(t time.Time) string`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ RFC3339 (UTC) –¥–ª—è –ª–æ–≥–æ–≤.

---

### üìè `func HumanSize(n int64) string`

–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –±–∞–π—Ç—ã –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (B, KB, MB). –ü—Ä–∏–º–µ—Ä:

```
HumanSize(2048) ‚Üí "2.0 KB"
HumanSize(3145728) ‚Üí "3.0 MB"
```

---

### üß† –ò—Ç–æ–≥

–ú–æ–¥—É–ª—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Å—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ (SD –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ),
* –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–ø–∏—Å—å —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞,
* –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–æ—Ç–∞—Ü–∏—é –∏ –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤,
* —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–æ–±–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤.

## üßæ internal/utils/logparser.go ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ –∏ —á—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤

–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Ç—Ä–æ–∫ –ª–æ–≥-—Ñ–∞–π–ª–æ–≤, —Ä–∞–∑–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ –∏ –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Å—Ç—Ä–æ–∫.

---

### üìÑ –û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

* —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–∏—Ö –ª–æ–≥–æ–≤ (–±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞);
* –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∞ `[timestamp] [LEVEL] message` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é map);
* –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª (–¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –∏–ª–∏ live tail).

---

### ‚öôÔ∏è –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏

```go
var (
	bracketLineRe = regexp.MustCompile(`^\[(?P<ts>[^]]+)\]\s*\[(?P<level>[^]]+)\]\s*(?P<msg>.*)$`)
	timeAltLayout = "2006-01-02 15:04:05,000" // —Ñ–æ—Ä–º–∞—Ç [2025-09-19 04:37:38,155]
)
```

* **`bracketLineRe`** ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Ä–µ–º—è, —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏.
* **`timeAltLayout`** ‚Äî —à–∞–±–ª–æ–Ω —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ –ª–æ–≥–∞—Ö.

---

### üìú `func ReadTailLines(f *os.File, n int) ([]string, error)`

–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —á–∏—Ç–∞–µ—Ç **–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫** –∏–∑ —Ñ–∞–π–ª–∞, –Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–Ω—Ü–∞.

#### üîç –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:

1. –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `f.Stat()`.
2. –°—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª —Å –∫–æ–Ω—Ü–∞ –±–ª–æ–∫–∞–º–∏ –ø–æ 4 KB, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ N —Å—Ç—Ä–æ–∫.
3. –†–∞–∑–¥–µ–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ `\n` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N.
4. –û—á–∏—â–∞–µ—Ç –ø—É—Å—Ç—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å.

üí° *–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, API –∏–ª–∏ Modbus) –±–µ–∑ —á—Ç–µ–Ω–∏—è –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞.*

---

### üß© `func ParseBracketLine(s string) map[string]any`

–ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞:

```
[2025-09-19 04:37:38,155] [ERROR] ModbusServiceFunctions::ReadInt: Read timeout
```

–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ—ë –≤ JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```json
{
  "time": "2025-09-19T04:37:38.155Z",
  "level": "error",
  "module": "ModbusServiceFunctions",
  "message": "Read timeout",
  "raw": "[2025-09-19 04:37:38,155] [ERROR] ModbusServiceFunctions::ReadInt: Read timeout"
}
```

#### üîç –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–∑–±–æ—Ä–∞:

1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª—è `ts`, `level`, `msg` —Å –ø–æ–º–æ—â—å—é `bracketLineRe`.
2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç `ts` –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ `2006-01-02 15:04:05,000` –≤ `RFC3339Nano`.
3. –†–∞–∑–¥–µ–ª—è–µ—Ç `msg` –ø–æ `::` –∏ `:` –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è `module` –∏ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ `message`.
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

–ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à–∞–±–ª–æ–Ω—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `map[string]any{"raw": s}`.

---

### üîÑ `func StreamLines(r io.Reader, ch chan<- string)`

–ß–∏—Ç–∞–µ—Ç –≤—Ö–æ–¥–Ω–æ–π –ø–æ—Ç–æ–∫ (`io.Reader`) –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–∞–Ω–∞–ª `ch`.

#### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:

1. –°–æ–∑–¥–∞—ë—Ç `bufio.Scanner` –¥–ª—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è.
2. –ü–µ—Ä–µ–¥–∞—ë—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–∞–Ω–∞–ª.
3. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á—Ç–µ–Ω–∏—è ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–∞–Ω–∞–ª.

üí° *–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –ª–æ–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ live-—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –ª–æ–≥–æ–≤ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏–ª–∏ CLI).*
